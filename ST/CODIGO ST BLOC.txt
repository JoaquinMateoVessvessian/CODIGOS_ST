//VESSVESSIAN, BAIRROS, KANG, SAGGIORATTO

#include <ESP32Time.h>

#include <U8g2lib.h>
#include <U8x8lib.h>

#include <DHT.h>
#include <DHT_U.h>

#include <Adafruit_Sensor.h>
U8G2_SH1106_128X64_NONAME_F_HW_I2C u8g2(U8G2_R0, /* reset=*/U8X8_PIN_NONE);
void Maquina(float t, int Estado, int EstadoBoton1, int EstadoBoton2);
#define DHTPIN 23
#define DHTTYPE DHT11
#define P1 200
#define P2 300
#define ESPERA 400
#define SUMAHORA 500
#define SUMAMIN 600
#define BOTON1 35
#define BOTON2 34
int boton1;
int boton2;
int hora = 11;
int minute = 39;
ESP32Time rtc(3600);
int estado;
DHT dht(DHTPIN, DHTTYPE);
void setup() {
  Serial.begin(9600);
  rtc.setTime(30, minute, hora, 25, 4, 2025);
  Serial.println(F("OLED test"));
  u8g2.begin();
  dht.begin();
  estado = P1;
}

void loop() {
  float t = dht.readTemperature();
  boton1 = digitalRead(BOTON1);
  boton2 = digitalRead(BOTON2);
  Maquina(t, estado, boton1, boton2);
  delay(2000);
}
void Maquina(float t, int Estado, int EstadoBoton1, int EstadoBoton2) {
  bool PASAJE;
  switch (Estado) {
    case P1:
      u8g2.clearBuffer();
      char stringt[6];
      u8g2.setFont(u8g2_font_ncenB08_tr);
      sprintf(stringt, "%.2f", t);
      u8g2.drawStr(15, 15, stringt);
      u8g2.drawStr(30, 15, rtc.getTime("%A, %B %d %Y %H:%M:%S"));
      u8g2.sendBuffer();
      PASAJE = true;
      if (EstadoBoton1 == 1 && EstadoBoton2 == 1) {
        Estado = ESPERA;
      }
      break;
    case ESPERA:
      if (EstadoBoton1 == 0 && EstadoBoton2 == 0) {
        if (PASAJE == false) {
          Estado = P1;
        }
        if (PASAJE == true) {
          Estado = P2;
        }
      }
      break;
    case P2:
      u8g2.clearBuffer();
      if (EstadoBoton1 == 1) {
        Estado = SUMAHORA;
      }
      if (EstadoBoton2 == 1) {
        Estado = SUMAMIN;
      }
      u8g2.drawStr(15, 15, rtc.getTime("%A, %B %d %Y %H:%M:%S"));
      u8g2.sendBuffer();
      PASAJE = false;
      if (EstadoBoton1 == 1 && EstadoBoton2 == 1) {
        Estado = ESPERA;
      }
      break;
    case SUMAHORA:
      hora = hora + 1;
      if (hora > 60) {
        hora = 0;
      }
      Estado = P2;
      break;
    case SUMAMIN:
      minute = minute + 1;
      if (minute > 60) {
        minute = 0;
      }
      Estado = P2;
      break;
  }
}
